{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "f7b458ac_20108efc",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1001074
      },
      "writtenOn": "2023-05-30T20:52:45Z",
      "side": 1,
      "message": "Thoralf, please let me know your thoughts before I proceed.\nThanks,",
      "revId": "7c26eca8f2889442c7dd1ff091c3063d71be8635",
      "serverId": "84e4e190-e623-4c37-9eda-58b1937c1b53"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "30d230ea_e43f0e5e",
        "filename": "src/rmr/si/src/rmr_si.c",
        "patchSetId": 3
      },
      "lineNbr": 777,
      "author": {
        "id": 1000108
      },
      "writtenOn": "2023-05-30T09:20:41Z",
      "side": 1,
      "message": "I understand that get_default_ip will return the first IP in the list of IPs returned by mk_ip_list(). In dual-stack the lookup probably doesn\u0027t work very predictable (assuming that interfaces have IP v4 and IPv6 addresses assigned). So, I see this primarily used with “RMR_BIND_IF” being set to a concrete (IPv4 or IPv6) IP address - in which case  mk_ip_list() anyway only returns exactly the IP address given in the environment variable. And I understand that case worked with IPv6 already. Now the only added case that works seems to be an IPv6-only stack. I am fine with that. Maybe one more comment explaining this here (where we have the ‘[‘ comparison) would keep this more maintainable without now trying to invent some elaborate scheme to select IPv4 vs IPv6 in dual-stack environments. Let me know if I misunderstood the logic here.",
      "range": {
        "startLine": 777,
        "startChar": 18,
        "endLine": 777,
        "endChar": 20
      },
      "revId": "7c26eca8f2889442c7dd1ff091c3063d71be8635",
      "serverId": "84e4e190-e623-4c37-9eda-58b1937c1b53"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e567d2b_84fd29bf",
        "filename": "src/rmr/si/src/rmr_si.c",
        "patchSetId": 3
      },
      "lineNbr": 777,
      "author": {
        "id": 1001074
      },
      "writtenOn": "2023-05-30T20:52:45Z",
      "side": 1,
      "message": "Exactly, mk_ip_list() will return all IPv* addresses but the ones from lo interface.\nSince get_default_ip() will return the first IP from the list, in fact, in dual stack it could be non-deterministic by returning an IPv4 address, and then it might return an IPv6 on restarting the application.\n\nWe have two possibilities here:\n1 - Write a better documentation in line 777 as you mentioned.\n2- Another solution for this non-deterministic behavior is improving the logic on get_default_ip() to return always the same IP address. I mean, we can prioritize IPv6 over IP4 (or vice-versa) on dual-stack, while sorting interface names in mk_ip_list() if there is more than one.\nThis can be easily implemented if it sounds reasonable to you.\n\nPlease, let me know your thoughts on this.",
      "parentUuid": "30d230ea_e43f0e5e",
      "range": {
        "startLine": 777,
        "startChar": 18,
        "endLine": 777,
        "endChar": 20
      },
      "revId": "7c26eca8f2889442c7dd1ff091c3063d71be8635",
      "serverId": "84e4e190-e623-4c37-9eda-58b1937c1b53"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e2aaa444_cc46a3ca",
        "filename": "src/rmr/si/src/rmr_si.c",
        "patchSetId": 3
      },
      "lineNbr": 777,
      "author": {
        "id": 1000108
      },
      "writtenOn": "2023-06-01T06:03:02Z",
      "side": 1,
      "message": "First thing coming to my mind was an environment variable telling RMR whether it should use IPv6, IPv4, or existing behavior. But that makes things even more complex.\n\nWhen I saw ENV_BIND_IF, I actually thought it is used to bind to specific interfaces, i.e., SO_BINDTODEVICE. But changing it now is probably too late and it\u0027s a bigger change. And it would still leave it open what kind of specific IP address to bind to - which I think is anyway better passed as explicit value. \n\nMaybe we should interpret the existing ENV_BIND_IF as normally defining an IP Address (either IPv4 or IPv6 \"ANY\" or a specific IPv4 or IPv6 address). \n\nAnd if it defines an interface, then we just use ANY as IP address and additionally bind to the interface via SO_BINDTODEVICE. And the combination of specific IP address plus also usage of SO_BINDTODEVICE we don\u0027t support.\n\nThis changes behavior slightly in that currently if an interface is given, it listens on that unpredictable IP address of that interface to a behavior where it listens on ANY (i.e., also the IP address it previously used, but also additional ones of that interface) and also applies SO_BINDTODEVICE.\n\nThe problem that remains is how decide whether to have IPv4 or IPv6 sockets. Maybe we add that new environment variable I mentioned in the beginning, but with slightly different semantics: ENV_BIND_IF_IPV6 which has exactly the same semantics as ENV_BIND_IF I described in the paragraph above. If both are defined, we only do only the things that ENV_BIND_IF tells us to do.  If none is defined, we do IPv4 with 0.0.0.0 and no SO_BINDTODEVICE.\n\nLooks to me like a bit of cleanup, well defined behavior, backwards compatible and some logic that is easy to explain.\n\nWhat do you think?",
      "parentUuid": "9e567d2b_84fd29bf",
      "range": {
        "startLine": 777,
        "startChar": 18,
        "endLine": 777,
        "endChar": 20
      },
      "revId": "7c26eca8f2889442c7dd1ff091c3063d71be8635",
      "serverId": "84e4e190-e623-4c37-9eda-58b1937c1b53"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7bb3fe6c_0a4e5e87",
        "filename": "src/rmr/si/src/rmr_si.c",
        "patchSetId": 3
      },
      "lineNbr": 777,
      "author": {
        "id": 1001074
      },
      "writtenOn": "2023-06-03T03:02:19Z",
      "side": 1,
      "message": "Not sure if introducing a new environment variable (ENV_BIND_IF_IPV6) with slightly different semantics of ENV_BIND_IF would be even more confusing. It would be difficult to explain as well.\n\nI have been thinking here, what is the possibility (in a production deployment) of a given container restarting and having its interfaces renamed, or reordering some of its IP addresses of an interface that would break the logic proposed in this commit?\n\nMay be writing a better documentation on line 777 as you proposed initially is the best for now.",
      "parentUuid": "e2aaa444_cc46a3ca",
      "range": {
        "startLine": 777,
        "startChar": 18,
        "endLine": 777,
        "endChar": 20
      },
      "revId": "7c26eca8f2889442c7dd1ff091c3063d71be8635",
      "serverId": "84e4e190-e623-4c37-9eda-58b1937c1b53"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8ddd29e6_86246c2d",
        "filename": "src/rmr/si/src/rmr_si.c",
        "patchSetId": 3
      },
      "lineNbr": 777,
      "author": {
        "id": 1000108
      },
      "writtenOn": "2023-06-05T06:27:56Z",
      "side": 1,
      "message": "line 777 change is ok for me.",
      "parentUuid": "7bb3fe6c_0a4e5e87",
      "range": {
        "startLine": 777,
        "startChar": 18,
        "endLine": 777,
        "endChar": 20
      },
      "revId": "7c26eca8f2889442c7dd1ff091c3063d71be8635",
      "serverId": "84e4e190-e623-4c37-9eda-58b1937c1b53"
    }
  ]
}